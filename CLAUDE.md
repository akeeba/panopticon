# CLAUDE.md

This file provides guidance to Claude Code (claude.ai/code) when working with code in this repository.

## Project Overview

Akeeba Panopticon is a self-hosted PHP application for remotely monitoring and managing Joomla and WordPress sites. It tracks updates, extensions, backups, SSL certificates, domain expiration, uptime, and security issues across multiple CMS installations.

## Build & Development Commands

```bash
# Full setup (installs PHP deps, runs npm install, compiles SCSS, transpiles JS, generates version.php, updates DB schema)
composer install

# Update PHP dependencies (also triggers full frontend build)
composer update

# Rebuild frontend assets only (npm install + copy deps + babel + SCSS + TinyMCE langs)
composer run-script npm-deps

# Compile SCSS only
composer run-script scss

# CLI entry point
php cli/panopticon.php list                    # List all commands
php cli/panopticon.php help <command>          # Help for specific command
php cli/panopticon.php config:create           # Create configuration
php cli/panopticon.php task:run                # Execute background tasks
php cli/panopticon.php database:backup         # Backup database
php cli/panopticon.php database:update         # Update database schema
```

There is no automated test suite. The CI/CD workflow exists (`.github/workflows/php.yml`) but is currently disabled.

## Architecture

### Framework
Built on **Akeeba Web Framework (AWF)** — a custom MVC framework. Not Joomla, Laravel, or Symfony (though it uses Symfony components for CLI, caching, error handling, and serialization).

### MVC Pattern
- **Controllers**: `src/Controller/` — handle HTTP requests
- **Models**: `src/Model/` — business logic and data access (extend AWF DataModel/Model)
- **View Classes**: `src/View/` — data preparation for templates
- **View Templates**: `ViewTemplates/` — Blade templates (`.blade.php`)

### Dependency Injection
`src/Container.php` extends AWF's Container. Key services registered as lazy factory closures:
- `appConfig` (Configuration), `cacheFactory`, `httpFactory`, `mailer`, `taskRegistry`, `loggerFactory`, `logger`, `queueFactory`
- Access via `Factory::getContainer()`

### Background Task System
Central to the application. Tasks run via CRON (`php cli/panopticon.php task:run`) or web CRON.
- **Task implementations**: `src/Task/` — 24 task types (backups, updates, monitoring, email, scanning)
- **Task registry**: `src/Library/Task/Registry.php` — discovers tasks via PHP 8 attributes
- **Director pattern**: "Director" tasks orchestrate per-site tasks (e.g., `JoomlaUpdateDirector` creates individual `JoomlaUpdate` tasks per site)

### CLI Commands
80+ Symfony Console commands in `src/CliCommand/`. Each uses PHP 8 attributes for metadata. Categories: config, site, user, group, task, backup/scanner schedules, mail templates, database, self-update, log rotation.

### Plugin System
`src/Plugin/` with `PluginHelper` for discovery. User-extensible via `user_code/` directory (included in PSR-4 autoload under `Akeeba\Panopticon\` namespace).

### Key Libraries (`src/Library/`)
- `Cache/` — Symfony Cache abstraction (filesystem, Redis, Memcached)
- `Http/` — Guzzle HTTP client factory with caching middleware
- `Task/` — Task queue and registry core
- `MultiFactorAuth/`, `Passkey/`, `Password/` — Authentication (WebAuthn/FIDO2, TOTP, HIBP checking)
- `Mailer/` — Email sending
- `Logger/` — Monolog-based logging with rotation
- `SelfUpdate/` — Self-update mechanism
- `Enumerations/` — PHP 8.1 enums

### Frontend
- **CSS**: Bootstrap 5.3, FontAwesome 6, custom SCSS in `media/scss/` compiled to `media/css/`
- **JS**: Vanilla JS + Petite Vue for reactivity, transpiled via Babel. Source and output both in `media/js/`
- **Editors**: TinyMCE (rich text), ACE (code editing)
- **Select fields**: Choices.js
- Node dependencies are copied to `media/` subdirectories by the Composer build script (`src/Composer/InstallationScript.php`), not served from `node_modules/`

### Database
MySQL 5.7+ or MariaDB 10.3+. Schema defined in `src/schema/mysql.xml` (Phing format). Table prefix: `pnptc_`. Drivers: PDO MySQL (preferred), MySQLi (fallback).

### Configuration
- `config.php` — main app config (generated by installer or CLI)
- `.env` files — environment variables via phpdotenv (supports `.env.{PANOPTICON_ENVIRONMENT}`)
- `defines.php` — path constants (`APATH_ROOT`, `APATH_MEDIA`, `APATH_CACHE`, etc.)
- `user_code/.env` — user override environment

### Translation
Language files in `languages/` using `.ini` format. English (GB) is the only officially maintained language.

## Coding Conventions

- **PHP**: Tabs for indentation, Allman brace style (opening braces on new line), `else`/`catch`/`finally` on new line
- **PHP version**: 8.1 minimum, 8.3 recommended. Uses typed properties, union types, named arguments, constructor promotion, match expressions, attributes, enums, nullsafe operator
- **SCSS**: 2-space indentation
- **JS**: 4-space indentation, double quotes, semicolons, Allman brace style
- **JSON**: Tab indentation
- **Line length**: 120 characters max
- **Namespace**: `Akeeba\Panopticon\{Component}` with PSR-4 autoloading from `src/` and `user_code/`
- **Security guard**: All PHP files start with `defined('AKEEBA') || die;`
- **License header**: Every PHP file has a `@package panopticon` / `@copyright` / `@license` docblock

## Docker

`Dockerfile` uses PHP 8.4 Apache. `docker-compose.yml` for full stack. Alternative FrankenPHP setup in `docker-compose-frankenphp.yml`. Docker detection via absence of `src/.not_docker` file.
