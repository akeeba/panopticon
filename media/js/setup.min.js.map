{"version":3,"file":"setup.min.js","names":["pageInstructions","document","getElementById","pageBenchmark","pageError","lastElapsed","handleError","errorText","classList","add","remove","innerHTML","pingTimer","window","setInterval","monitorBenchmark","options","akeeba","System","getOptions","Ajax","ajax","url","type","cache","success","responseText","i","response","JSON","parse","e","clearInterval","doc","DOMParser","parseFromString","Text","_","documentElement","textContent","console","debug","hasTask","error","started","contains","hasStuck","elapsed","finished","location","concat","nextPage","token","absoluteElapsed","percentElapsed","Math","floor","min","progressFill","style","width","innerText","xhr","reason","Request","status","statusText","readyState"],"sources":["setup.js"],"sourcesContent":["/*\n * @package   panopticon\n * @copyright Copyright (c)2023-2024 Nicholas K. Dionysopoulos / Akeeba Ltd\n * @license   https://www.gnu.org/licenses/agpl-3.0.txt GNU Affero General Public License, version 3 or later\n */\n\n(() =>\n{\n    const pageInstructions = document.getElementById(\"instructions\");\n    const pageBenchmark    = document.getElementById(\"benchmark\");\n    const pageError        = document.getElementById(\"error\");\n\n    var lastElapsed = -1;\n\n    const handleError = (errorText) =>\n    {\n        pageInstructions.classList.add('d-none');\n        pageBenchmark.classList.add('d-none');\n        pageError.classList.remove('d-none');\n\n        document.getElementById('errorMessage').innerHTML = errorText;\n    }\n\n    const monitorBenchmark = () =>\n    {\n        const options = akeeba.System.getOptions(\"panopticon.benchmark\")\n        akeeba.Ajax.ajax(\n            options.url,\n            {\n                type:    \"GET\",\n                cache:   false,\n                success: (responseText, statusText, xhr) =>\n                         {\n                             let response = null;\n\n                             try\n                             {\n                                 response = JSON.parse(responseText);\n                             }\n                             catch (e)\n                             {\n                                 window.clearInterval(pingTimer);\n\n                                 const doc = new DOMParser().parseFromString(responseText ?? \"\", \"text/html\");\n\n                                 handleError(\n                                     akeeba.System.Text._(\"PANOPTICON_SETUP_CRON_ERR_INVALID_JSON\") +\n                                     \"<pre>\" +\n                                     doc.documentElement.textContent +\n                                     \"</pre>\"\n                                 )\n                             }\n\n                             console.debug(response);\n\n                             // Make sure we have a task\n                             if (!response.hasTask)\n                             {\n                                 window.clearInterval(pingTimer);\n\n                                 handleError(akeeba.System.Text._(\"PANOPTICON_SETUP_CRON_ERR_NO_MAXEXEC_TASK\"));\n                             }\n\n                             // Error handling\n                             if (response.error)\n                             {\n                                 window.clearInterval(pingTimer);\n\n                                 handleError(response.error);\n                             }\n\n                             // If the benchmark has not started, bail out\n                             if (!response.started)\n                             {\n                                 return;\n                             }\n\n                             // Show the correct page, if necessary.\n                             if (pageBenchmark.classList.contains('d-none'))\n                             {\n                                 pageBenchmark.classList.remove('d-none');\n                                 pageInstructions.classList.add('d-none');\n                             }\n\n                             // Have we finished?\n                             var hasStuck = lastElapsed === response.elapsed;\n                             lastElapsed = response.elapsed;\n\n                             if (response.finished || response.elapsed >= 180 || hasStuck)\n                             {\n                                 window.clearInterval(pingTimer);\n\n                                 window.location = `${options.nextPage}&${options.token}=1&maxexec=${response.elapsed}`;\n\n                                 return;\n                             }\n\n                             // Update the progress bar\n                             const absoluteElapsed = response.elapsed ?? 0;\n                             const percentElapsed = Math.floor(Math.min(1, response.elapsed / 180) * 100);\n\n                             const progressFill = document.getElementById('progressFill');\n                             progressFill.style.width = percentElapsed + '%';\n                             progressFill.innerText = absoluteElapsed + ' s';\n                         },\n                error:   (xhr, reason, ignored) =>\n                         {\n                             window.clearInterval(pingTimer);\n\n                             var error = '';\n\n                             switch (reason)\n                             {\n                                 case 'timeout':\n                                     error = ajax.System.Text._('PANOPTICON_SETUP_CRON_ERR_XHR_TIMEOUT');\n                                     break;\n\n                                 case 'abort':\n                                     error = ajax.System.Text._('PANOPTICON_SETUP_CRON_ERR_XHR_ABORT');\n                                     break;\n\n                                default:\n                                 case 'error':\n                                     const doc = new DOMParser().parseFromString(Request.responseText ? Request.responseText : \"\", \"text/html\");\n\n                                     error = akeeba.System.Text._('PANOPTICON_SETUP_CRON_ERR_AJAX_HEAD') + '<br>'\n                                         + akeeba.System.Text._('PANOPTICON_SETUP_CRON_ERR_AJAX_HTTP_STATUS') +\n                                         xhr.status + ' (' + xhr.statusText + ')<br>' +\n                                         akeeba.System.Text._('PANOPTICON_SETUP_CRON_ERR_AJAX_HTTP_READYSTATE') +\n                                         xhr.readyState + '<br>' +\n                                         akeeba.System.Text._('PANOPTICON_SETUP_CRON_ERR_AJAX_HTTP_RAW') +\n                                         '<div class=\"p-2 m-2 border rounded bg-light-subtle text-muted\">' +\n                                         doc.documentElement.textContent\n                                         + '</div>';\n                                     break;\n                             }\n\n                             handleError(error);\n                         }\n            }\n        )\n    };\n\n    pageInstructions.classList.remove(\"d-none\");\n    pageBenchmark.classList.add(\"d-none\");\n    pageError.classList.add(\"d-none\");\n\n    const pingTimer = window.setInterval(monitorBenchmark, 5000);\n})()\n"],"mappings":"AAMA,CAAC,UACD,IACU,CAAAA,CAAgB,CAAGC,QAAQ,CAACC,cAAc,CAAC,cAAc,CAAC,CAC1DC,CAAa,CAAMF,QAAQ,CAACC,cAAc,CAAC,WAAW,CAAC,CACvDE,CAAS,CAAUH,QAAQ,CAACC,cAAc,CAAC,OAAO,CAAC,CAErDG,CAAW,CAAG,CAAC,CAAC,CAEdC,CAAW,CAAG,QAAAA,CAACC,CAAS,CAC9B,CACIP,CAAgB,CAACQ,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC,CACxCN,CAAa,CAACK,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC,CACrCL,CAAS,CAACI,SAAS,CAACE,MAAM,CAAC,QAAQ,CAAC,CAEpCT,QAAQ,CAACC,cAAc,CAAC,cAAc,CAAC,CAACS,SAAS,CAAGJ,CACxD,CAAC,CA0HDP,CAAgB,CAACQ,SAAS,CAACE,MAAM,CAAC,QAAQ,CAAC,CAC3CP,CAAa,CAACK,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC,CACrCL,CAAS,CAACI,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC,CAEjC,GAAM,CAAAG,CAAS,CAAGC,MAAM,CAACC,WAAW,CA5HX,QAAnB,CAAAC,gBAAgBA,CAAA,CACtB,CACI,GAAM,CAAAC,CAAO,CAAGC,MAAM,CAACC,MAAM,CAACC,UAAU,CAAC,sBAAsB,CAAC,CAChEF,MAAM,CAACG,IAAI,CAACC,IAAI,CACZL,CAAO,CAACM,GAAG,CACX,CACIC,IAAI,CAAK,KAAK,CACdC,KAAK,GAAS,CACdC,OAAO,CAAE,SAAAA,QAACC,CAAY,CACb,KAAAC,CAAA,CACQC,CAAQ,CAAG,IAAI,CAEnB,GACA,CACIA,CAAQ,CAAGC,IAAI,CAACC,KAAK,CAACJ,CAAY,CACtC,CACA,MAAOK,CAAC,CACR,CACIlB,MAAM,CAACmB,aAAa,CAACpB,CAAS,CAAC,CAE/B,GAAM,CAAAqB,CAAG,CAAG,GAAI,CAAAC,SAAS,CAAC,CAAC,CAACC,eAAe,QAACT,CAAY,WAAZA,CAAY,CAAZA,CAAY,CAAI,EAAE,CAAE,WAAW,CAAC,CAE5EpB,CAAW,CACPW,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,wCAAwC,CAAC,CAC9D,OAAO,CACPJ,CAAG,CAACK,eAAe,CAACC,WAAW,CAC/B,QACJ,CACJ,CAqBA,GAnBAC,OAAO,CAACC,KAAK,CAACb,CAAQ,CAAC,CAGlBA,CAAQ,CAACc,OAAO,GAEjB7B,MAAM,CAACmB,aAAa,CAACpB,CAAS,CAAC,CAE/BN,CAAW,CAACW,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,2CAA2C,CAAC,CAAC,EAI9ET,CAAQ,CAACe,KAAK,GAEd9B,MAAM,CAACmB,aAAa,CAACpB,CAAS,CAAC,CAE/BN,CAAW,CAACsB,CAAQ,CAACe,KAAK,CAAC,GAI3B,CAACf,CAAQ,CAACgB,OAAO,EAMjBzC,CAAa,CAACK,SAAS,CAACqC,QAAQ,CAAC,QAAQ,CAAC,GAE1C1C,CAAa,CAACK,SAAS,CAACE,MAAM,CAAC,QAAQ,CAAC,CACxCV,CAAgB,CAACQ,SAAS,CAACC,GAAG,CAAC,QAAQ,CAAC,EAI5C,GAAI,CAAAqC,CAAQ,CAAGzC,CAAW,GAAKuB,CAAQ,CAACmB,OAAO,CAG/C,GAFA1C,CAAW,CAAGuB,CAAQ,CAACmB,OAAO,CAE1BnB,CAAQ,CAACoB,QAAQ,EAAwB,GAAG,EAAvBpB,CAAQ,CAACmB,OAAc,EAAID,CAAQ,CAMxD,MAJA,CAAAjC,MAAM,CAACmB,aAAa,CAACpB,CAAS,CAAC,MAE/BC,MAAM,CAACoC,QAAQ,IAAAC,MAAA,CAAMlC,CAAO,CAACmC,QAAQ,MAAAD,MAAA,CAAIlC,CAAO,CAACoC,KAAK,gBAAAF,MAAA,CAActB,CAAQ,CAACmB,OAAO,CAAE,EAGzF,GAGK,CAAAM,CAAe,SAAA1B,CAAA,CAAGC,CAAQ,CAACmB,OAAO,YAAApB,CAAA,CAAAA,CAAA,CAAI,CAAC,CACvC2B,CAAc,CAAGC,IAAI,CAACC,KAAK,CAAuC,GAAG,CAAzCD,IAAI,CAACE,GAAG,CAAC,CAAC,CAAE7B,CAAQ,CAACmB,OAAO,CAAG,GAAG,CAAO,CAAC,CAEtEW,CAAY,CAAGzD,QAAQ,CAACC,cAAc,CAAC,cAAc,CAAC,CAC5DwD,CAAY,CAACC,KAAK,CAACC,KAAK,CAAGN,CAAc,CAAG,GAAG,CAC/CI,CAAY,CAACG,SAAS,CAAGR,CAAe,CAAG,IAAI,CACnD,CAAC,CACVV,KAAK,CAAI,QAAAA,CAACmB,CAAG,CAAEC,CAAM,CACZ,CACIlD,MAAM,CAACmB,aAAa,CAACpB,CAAS,CAAC,CAE/B,GAAI,CAAA+B,CAAK,CAAG,EAAE,CAEd,OAAQoB,CAAM,EAEV,IAAK,SAAS,CACVpB,CAAK,CAAGtB,IAAI,CAACH,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,uCAAuC,CAAC,CACnE,MAEJ,IAAK,OAAO,CACRM,CAAK,CAAGtB,IAAI,CAACH,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,qCAAqC,CAAC,CACjE,MAEL,QACC,IAAK,OAAO,CACR,GAAM,CAAAJ,CAAG,CAAG,GAAI,CAAAC,SAAS,CAAC,CAAC,CAACC,eAAe,CAAC6B,OAAO,CAACtC,YAAY,CAAGsC,OAAO,CAACtC,YAAY,CAAG,EAAE,CAAE,WAAW,CAAC,CAE1GiB,CAAK,CAAG1B,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,qCAAqC,CAAC,CAAG,MAAM,CACtEpB,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,4CAA4C,CAAC,CACpEyB,CAAG,CAACG,MAAM,CAAG,IAAI,CAAGH,CAAG,CAACI,UAAU,CAAG,OAAO,CAC5CjD,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,gDAAgD,CAAC,CACtEyB,CAAG,CAACK,UAAU,CAAG,MAAM,CACvBlD,MAAM,CAACC,MAAM,CAACkB,IAAI,CAACC,CAAC,CAAC,yCAAyC,CAAC,CAC/D,mEAAiE,CACjEJ,CAAG,CAACK,eAAe,CAACC,WAAW,CAC7B,QAEd,CAEAjC,CAAW,CAACqC,CAAK,CACrB,CACb,CACJ,CACJ,CAAC,CAMsD,GAAI,CAC/D,CAAC,EAAE,CAAC"}